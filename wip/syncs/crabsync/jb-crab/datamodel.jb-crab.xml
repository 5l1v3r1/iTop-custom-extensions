<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.5">

	<classes>     


		<class id="CrabStreet" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>crabstreet</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="name"></attribute>
					</attributes>
				</naming>

				<display_template/>
				<icon>images/crabstreet.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="crab_id"/>
						<attribute id="name"/>
						<attribute id="status"/>
					</attributes>
				</reconciliation>
			</properties> 

			<fields>
				<field id="crab_id" xsi:type="AttributeDecimal">
					<sql>crab_id</sql>
					<digits>10</digits>
					<decimals>0</decimals>
					<is_null_allowed>false</is_null_allowed> 
				</field>

				<field id="name" xsi:type="AttributeString">
					<sql>crab_street</sql>
					<is_null_allowed>false</is_null_allowed>  
				</field>


				<field id="status" xsi:type="AttributeEnum">
					<sql>status</sql>
					<is_null_allowed>false</is_null_allowed>  
					<values>
						<value id="1">1</value>
						<value id="2">2</value>
						<value id="3">3</value>
						<value id="4">4</value>
					</values>
				</field> 
				
				
				<field id="list_addresses" xsi:type="AttributeLinkedSet">
					<linked_class>CrabAddress</linked_class>
					<ext_key_to_me>street_id</ext_key_to_me>
				</field>
				
			</fields> 
			<presentation>
				<details>
					<items>
						<item id="col:col1">
							<rank>10</rank>
							<items>
								<item id="fieldset:CrabStreet:baseinfo">
									<items>
										<item id="crab_id">
											<rank>1</rank>
										</item>
										<item id="name">
											<rank>5</rank>
										</item>
										<item id="status">
											<rank>10</rank>
										</item>

										<item id="list_addresses">
											<rank>110</rank>
										</item>
										
									</items>
								</item>
							</items>
						</item>

					</items>
				</details>
				<search>
					<items>
						<item id="crab_id">
							<rank>1</rank>
						</item>
						<item id="name">
							<rank>5</rank>
						</item>
						<item id="status">
							<rank>10</rank>
						</item>



					</items>
				</search>
				<list>
					<items>


						<item id="crab_id">
							<rank>5</rank>
						</item>
						<item id="name">
							<rank>5</rank>
						</item>
						<item id="status">
							<rank>10</rank>
						</item>


					</items>
				</list>
			</presentation>

			<methods/>


		</class>




		<class id="CrabAddress" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>crabaddress</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes> 
						<!-- Interesting, friendlyname of other class can be used here! -->
						<attribute id="street_id_friendlyname"/>
						<attribute id="house_number"/>
						<attribute id="apartment_number"/>
						<attribute id="sub_number"/>
					</attributes>
				</naming>

				<display_template/>
				<icon>images/crabaddress.png</icon>
				<reconciliation>
					<attributes> 
						<attribute id="crab_id"/>
						<attribute id="street_id"/>
						<attribute id="house_number"/>
						<attribute id="apartment_number"/>
						<attribute id="sub_number"/>
					</attributes>
				</reconciliation>
			</properties>


			<fields>


				<field id="crab_id" xsi:type="AttributeDecimal">
					<sql>crab_id</sql>
					<digits>10</digits>
					<decimals>0</decimals>
					<is_null_allowed>false</is_null_allowed> 
				</field>

				<!-- This is iTop's internal street ID, NOT the Crab ID -->
				<field id="street_id" xsi:type="AttributeExternalKey">
					<sql>street_id</sql>
					<on_target_delete>DEL_AUTO</on_target_delete>
					<target_class>CrabStreet</target_class>
					<is_null_allowed>false</is_null_allowed> 
				</field>

				<field id="house_number" xsi:type="AttributeString">
					<sql>house_number</sql>
					<is_null_allowed>false</is_null_allowed>  
				</field>


				<field id="status" xsi:type="AttributeEnum">
					<sql>status</sql>
					<is_null_allowed>false</is_null_allowed>  
					<values>
						<value id="1">1</value>
						<value id="2">2</value>
						<value id="3">3</value>
						<value id="4">4</value>
						<value id="5">5</value>
						<value id="99">99</value>
					</values>
				</field>



				<field id="apartment_number" xsi:type="AttributeString">
					<sql>apartment_number</sql>
					<digits>10</digits>
					<decimals>0</decimals>
					<is_null_allowed>true</is_null_allowed> 
				</field>


				<field id="sub_number" xsi:type="AttributeString">
					<sql>sub_number</sql>
					<digits>10</digits>
					<decimals>0</decimals>
					<is_null_allowed>true</is_null_allowed> 
				</field>


				<field id="geom" xsi:type="AttributeText">
					<sql>geom</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>

			</fields> 
			<presentation>
				<details>
					<items>
						<item id="col:col1">
							<rank>10</rank>
							<items>
								<item id="fieldset:CrabAddress:baseinfo">
									<items>
										<item id="crab_id">
											<rank>5</rank>
										</item> 

										<item id="street_id">
											<rank>15</rank>
										</item>

										<item id="house_number">
											<rank>20</rank>
										</item>

										<item id="apartment_number">
											<rank>25</rank>
										</item>
										<item id="sub_number">
											<rank>30</rank>
										</item>


									</items>
								</item>
							</items>
						</item>
						<item id="geom">
							<rank>20</rank>
						</item>
					</items>
				</details>
				<search>
					<items>

						<item id="crab_id">
							<rank>5</rank>
						</item>



						<item id="street_id">
							<rank>15</rank>
						</item>

						<item id="house_number">
							<rank>20</rank>
						</item>

						<item id="apartment_number">
							<rank>25</rank>
						</item>
						<item id="sub_number">
							<rank>30</rank>
						</item>


					</items>
				</search>
				<list>
					<items>

						<item id="crab_id">
							<rank>5</rank>
						</item>



						<item id="street_id">
							<rank>15</rank>
						</item>

						<item id="house_number">
							<rank>20</rank>
						</item>

						<item id="apartment_number">
							<rank>25</rank>
						</item>
						<item id="sub_number">
							<rank>30</rank>
						</item>


					</items>
				</list>
			</presentation>

			<methods>
			
				<method id="DisplayBareRelations" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-cmdbAbstractObject</type>
					<code><![CDATA[      public function DisplayBareRelations(WebPage $oPage, $bEditMode = false)
					{
						parent::DisplayBareRelations($oPage, $bEditMode);
	 
						// Module settings, defaults.
						$aGeomSettings = MetaModel::GetModuleSetting('jb-crab', 'default', array( 
							'datacrs' => 'EPSG:3857',
							'datatypes' => Array('Point','LineString','Polygon'),
							'mapcrs' => 'EPSG:3857',
							'mapcenter' =>  [ 358652.11242031807, 6606360.84951076 ],
							'mapzoom' => 17,
							'format' => 'WKT'
						)); 
						
						// Module settings, specifics. In XML, most nodes seem to start with a non-capital.
						if( MetaModel::GetModuleSetting('jb-crab', strtolower(get_class($this)), '') != '') {
							
							$aClassSpecificSettings = MetaModel::GetModuleSetting('jb-crab', strtolower(get_class($this)), array() ); 
							
							foreach( $aClassSpecificSettings as $k => $v ) {
								$aGeomSettings[$k] = $v;
							} 
							
						}
						
						
						$sGeomString = ( $aGeomSettings["dataformat"] == 'GeoJSON' ? addcslashes($this->Get('geom'), '"') : $this->Get('geom') ); 
						
						$sTabName = Dict::S('Location:Geometry');
						$oPage->SetCurrentTab($sTabName); 
						
						// It seems iTop just outputs a script as text if you set it in $oPage->add()? 						
						$oPage->add_linked_stylesheet("https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.1.3/css/ol.css");
						$oPage->add_linked_script("https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.1.3/build/ol.js");
												
						$oPage->add('<div id="ol-map" class="ol-map" style="width: 100%; height: 500px;"></div>');

						
						// 'add_script' is also a method
						// be careful what EPSG to select!
						// for testing purposes, we'll try to detect if Geometry was saved in GeoJSON or WKT and read it anyway
						// for geom.oFeature, use single quotes on the outside. Inner quotes will have been escaped.
						$oPage->add_ready_script('
							  
							geom = {};
							geom.oFormat = {
								WKT: new ol.format.WKT(),
								GeoJSON: new ol.format.GeoJSON()
							};
							geom.oFeatures = [];
							geom.oFeature = ( \''.$sGeomString.'\' != \'\' ? geom.oFormat.'.( preg_match('/^{"type":"Feature",.*/', $sGeomString) == TRUE ? 'GeoJSON' : 'WKT' ).'.readFeature(\''.$sGeomString.'\', { dataProjection: "'.$aGeomSettings["datacrs"].'", featureProjection: "'.$aGeomSettings["mapcrs"].'" }) : null );
							
							if( geom.oFeature !== null ) {
								geom.oFeatures.push( geom.oFeature );
							}
							
							geom.oVectorSource = new ol.source.Vector({ 
								features: geom.oFeatures
							});
							
							geom.oVectorLayer = new ol.layer.Vector({ 
								source: geom.oVectorSource, 
								style: ol_style
							});					

							if( geom.oFeature === null ) {
								geom.oCenter = [ '.$aGeomSettings["mapcenter"][0].', '.$aGeomSettings["mapcenter"][1].' ];
							}
							else {
								geom.oCenter = [ 
									( geom.oFeature.getGeometry().getExtent()[0] + geom.oFeature.getGeometry().getExtent()[2] ) / 2,
									( geom.oFeature.getGeometry().getExtent()[1] + geom.oFeature.getGeometry().getExtent()[3] ) / 2,
								];
							}
						 
							// Center: EPSG:3857 - [ 358652.11242031807, 6606360.84951076 ]
							geom.oMap = new ol.Map({
								target: "ol-map",
								layers: [
									// OpenLayers: the last layer you add, is on top.
									new ol.layer.Tile({
										source: new ol.source.OSM()
									}), 
									geom.oVectorLayer 
								],
								view: new ol.View({
									center: geom.oCenter,
									zoom: "'.$aGeomSettings["mapzoom"].'",
									projection: "'.$aGeomSettings["mapcrs"].'"
								})
							});
							
						
							// For some reason, OpenLayers displays a blank map, until you call updateSize() on the ol.Map object.
							// Could this have to do with iTop tab behavior? Further investigation needed, only seems to work on second click now (might just appear to do so). 
							// Not sure if it is an iTop (or Zend) issue, or OpenLayers. 
							// Work-around seems to be to add a minor delay before executing the ol.Map.updateSize() method
							// The tab container  
							$("ul[role=\'tablist\'] > li > a > span:contains(\''.$sTabName.'\')").parent().parent().on("click", function(evt){  
								setTimeout( function(){ geom.oMap.updateSize(); }, 1000);
							});
											
								 
							// Hide or disable ( textarea in edit mode! ). Click event will not work here (to show Geometry tab)
							// Alternatively, you could do this with CSS
							$("div[data-attcode=\'geom\']").hide();
														
							function ol_style(feature) {
								switch( feature.getGeometry().getType() ) {
								
									case "Point": 
									
										return [
											new ol.style.Style({ 
												image: new ol.style.Circle({	
													radius: 10,
													fill: new ol.style.Fill({
													  color: "rgba(255, 0, 0, 0.6)"
													}),
													stroke: new ol.style.Stroke({
													  color: "rgba(255, 0, 0, 1)",
													  width: 1
													})
												})
											})
										];
										 
									default: 
										// Should not happen
										break;
								}
							}	
								 
								 
							// Fix: if you go to the Geometry tab first; then pick Modify, the map is not displayed properly either. 
							$(document).ready(function(){
								setTimeout( function(){ geom.oMap.updateSize(); }, 1000 );
							});

						'); 
						
					}  ]]></code>
					</method>
				</methods>


		</class>



	</classes>

	<!-- Adds a link to the ConfigManagement Overview -->
	<menus>

		<menu id="NewCrabStreet" xsi:type="NewObjectMenuNode" _delta="define">
			<rank>901</rank>
			<parent>ConfigManagement</parent>
			<class>CrabStreet</class>
		</menu>
		<menu id="SearchCrabStreet" xsi:type="SearchMenuNode" _delta="define">
			<rank>902</rank>
			<parent>ConfigManagement</parent>
			<class>CrabStreet</class> 
		</menu> 

		<menu id="NewCrabAddress" xsi:type="NewObjectMenuNode" _delta="define">
			<rank>901</rank>
			<parent>ConfigManagement</parent>
			<class>CrabAddress</class>
		</menu>
		<menu id="SearchCrabAddress" xsi:type="SearchMenuNode" _delta="define">
			<rank>902</rank>
			<parent>ConfigManagement</parent>
			<class>CrabAddress</class> 
		</menu> 



	</menus>

	<profiles/>
	
	 
	
	<module_parameters>
		<parameters id="jb-crab" _delta="define">
		
			<!-- Parameters are case sensitive! -->
			
			<!-- Defaults -->
			<default>
				<dataformat type="string" _delta="define">WKT</dataformat>
				<datacrs type="string" _delta="define">EPSG:3857</datacrs>
				<datatypes type="array" _delta="define">
					<datatype id="0">Point</datatype>
				</datatypes>
				<mapcrs type="string" _delta="define">EPSG:3857</mapcrs>				
				<mapcenter type="array" _delta="define">
					<coord id="0">358652.11242031807</coord>
					<coord id="1">6606360.84951076</coord>
				</mapcenter>
				<mapzoom type="int" _delta="define">17</mapzoom>
			</default>
			
			<!-- Class specific, but write in lowercase (XML convention) -->
			<crabaddress>
				<datatypes type="array" _delta="define">
					<datatype id="0">Point</datatype>
				</datatypes>				
			</crabaddress>
			
			
		</parameters>
	</module_parameters>
	 
	
	
	
	
	
	
</itop_design>
