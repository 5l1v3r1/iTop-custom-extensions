<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.5">
  <constants/>
	<classes>
		<class id="Location">
		<methods>
			<method id="DisplayBareRelations" _delta="define">
				<static>false</static>
				<access>public</access>
				<type>Overload-cmdbAbstractObject</type>
				<code><![CDATA[      public function DisplayBareRelations(WebPage $oPage, $bEditMode = false)
				{
					parent::DisplayBareRelations($oPage, $bEditMode);
						
					// View only
					
					if (!$bEditMode)
					{
					
						$sTabName = Dict::S('Location:Geolocation');
						$oPage->SetCurrentTab($sTabName); 
						
						// It seems iTop just outputs a script as text if you set it in $oPage->add()? 
						
						$oPage->add_linked_stylesheet("https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.1.3/css/ol.css");
						$oPage->add_linked_script("https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.1.3/build/ol.js");
						
						$oPage->add('<div id="ol-map" class="ol-map" style="width: 100%; height: 500px;"></div>');
						
						// 'add_script' is also a method
						// be careful what EPSG to select!
						$oPage->add_ready_script('
							  
							geoLoc = {};
							geoLoc.oFormat = new ol.format.WKT();
							geoLoc.oFeature = geoLoc.oFormat.readFeature("'.$this->Get('wktgeom').'", { dataProjection: "EPSG:4326", featureProjection: "EPSG:3857" });
							geoLoc.oFeatures = [ geoLoc.oFeature ];
							geoLoc.oVectorSource = new ol.source.Vector({ 
								features: geoLoc.oFeatures
							});
							geoLoc.oVectorLayer = new ol.layer.Vector({ 
								source: geoLoc.oVectorSource, 
								style: new ol.style.Style({ 
									image: new ol.style.Circle({	
										radius: 10,
										fill: new ol.style.Fill({
										  color: "rgba(255, 0, 0, 0.6)"
										}),
										stroke: new ol.style.Stroke({
										  color: "rgba(255, 0, 0, 1)",
										  width: 1
										})
									})
								}) 
							});							  
						
							geoLoc.oMap = new ol.Map({
								target: "ol-map",
								layers: [
									// OpenLayers: the last layer you add, is on top.
									new ol.layer.Tile({
										source: new ol.source.OSM()
									}), 
									geoLoc.oVectorLayer 
								],
								view: new ol.View({
									center: geoLoc.oFeature.getGeometry().getCoordinates(),
									zoom: 18,
									projection: "EPSG:3857"
								})
							});
							
						
							// For some reason, OpenLayers displays a blank map, until you call updateSize() on the ol.Map object.
							// Could this have to do with iTop tab behavior?	
							// Further investigation needed, only seems to work on second click now. Not sure if it's an iTop (or Zend) issue, or OpenLayers. 
							// Work-around seems to be to add a minor delay before executing the ol.Map.updateSize() method
							// Fix. 
							// The tab container  
							$("ul[role=\'tablist\'] > li > a > span:contains(\''.$sTabName.'\')").parent().parent().on("click", function(evt){  
								setTimeout( function(){ geoLoc.oMap.updateSize(); }, 1000);
							});
							// The actual tab. For some reason not triggered with code above.
							$("ul[role=\'tablist\'] > li > a > span:contains(\''.$sTabName.'\')").parent().on("click", function(evt){  
								setTimeout( function(){ geoLoc.oMap.updateSize(); }, 1000); 
							});
							// The actual link-part of the tab. For some reason not triggered with code above.
							$("ul[role=\'tablist\'] > li > a > span:contains(\''.$sTabName.'\')").on("click", function(evt){  
								setTimeout( function(){ geoLoc.oMap.updateSize(); }, 1000); 
							});
 
						');
						
					}
					
					
				}  ]]></code>
			</method>
		</methods>

		<fields> 
			<!-- takes up to 64kb -->
			<field id="wktgeom" xsi:type="AttributeText" _delta="define">
				<sql>wktgeom</sql>
				<default_value/>
				<is_null_allowed>true</is_null_allowed>
			</field>
		</fields>


		<presentation>
			<details>
				<items> 
					<item id="wktgeom" _delta="define">
						<rank>150</rank>
					</item>
				</items>
			</details>
		</presentation>

	</class>
	</classes>
	<menus/>
	<user_rights>
    <groups/>
    <profiles/>
	</user_rights>
</itop_design>
